<div class="content-wrapper">

    <div class="row page-tilte align-items-center">
        <div class="col-md-auto">
            <a href="#" class="mt-3 d-md-none float-right toggle-controls"><span class="material-icons">keyboard_arrow_down</span></a>
            <h1 class="weight-300 h3 title">产品管理 </h1>
            <!--<p class="text-muted m-0 desc">昨日未结订单 (共87)</p>-->
        </div>
        <div class="col controls-wrapper mt-3 mt-md-0 d-none d-md-block ">
            <div class="controls d-flex justify-content-center justify-content-md-end">
                <!--<input type="search" class="form-control d-inline-block" placeholder="在表格中搜索...">-->
                <!--<span class="dropdown">-->
                    <!--<button type="button" id="downloadGrid" data-toggle="dropdown"-->
                            <!--class="btn btn-secondary py-1 px-2"><span-->
                            <!--class="material-icons align-text-bottom">save_alt</span></button>-->
                    <!--<div class="dropdown-menu dropdown-menu-right" aria-labelledby="downloadGrid">-->
                      <!--<a class="dropdown-item" href="#">保存为 PDF</a>-->
                      <!--<a class="dropdown-item" href="#">保存为图像</a>-->
                      <!--<a class="dropdown-item" href="#">保存为 Word</a>-->
                      <!--<div class="dropdown-divider"></div>-->
                      <!--<a class="dropdown-item" href="#">导出 Excel</a>-->
                    <!--</div>-->
                    <!--</span>-->
                <button id="createNewProduct" type="button" class="btn btn-secondary py-1 px-2" data-toggle="modal"
                        data-target="#gridFilters"><span class="material-icons align-text-bottom">添加商品</span>
                </button>
            </div>
        </div>
    </div>

    <div class=" table-responsive">
        <table class="table mb-4 responsive-table table-bordered bg-white">
            <thead class="thead-light2">
            <tr>
                <th scope="col" width="1">产品图片</th>
                <th scope="col" class="resizeable">产品名称<span
                        class="material-icons align-text-bottom ml-1 md-18">sort</span></th>
                <th scope="col" class="resizeable">数量 <span
                        class="material-icons align-text-bottom ml-1 md-18">sort</span></th>
                <th scope="col" class="resizeable">价格 <span
                        class="material-icons align-text-bottom ml-1 md-18">sort</span></th>
                <th scope="col" class="resizeable">分类</th>
                <th scope="col" class="resizeable">描述</th>
                <th scope="col" class="resizeable">产品参数</th>
                <th scope="col" width="1">操作</th>
            </tr>
            </thead>
            <tbody id="orderList">
            </tbody>
        </table>
    </div>


    <nav aria-label="Page navigation example">
        <form class="form-inline float-left">
            <label class="my-1 mr-2 d-none d-md-block" ><!-- for="show-data" --> 共 <span id="OrderNum"></span> 个商品</label>
            <!--<select class="form-control" id="show-data">-->
                <!--<option selected>25</option>-->
                <!--<option value="1">50</option>-->
                <!--<option value="2">100</option>-->
                <!--<option value="3">全部</option>-->
            <!--</select>-->
        </form>
        <ul class="pagination mt-3 justify-content-end">
            <div style="flex: content;line-height: 2;"> 共 <span id="maxPage"></span> 页</div>
            <li class="page-item" id="prev">
                <button class="page-link" href="#" tabindex="-1">上一页</button>
            </li>
            <!--<li class="page-item"><button class="page-link" href="#">1</button></li>-->
            <li class="page-item active"><input type="text" style="width: 120px" class="input-block-level page-link text-center bg-white" href="#" id="now" /></li>
            <!--<li class="page-item"><button class="page-link" href="#">3</button></li>-->
            <li class="page-item" id="next">
                <button class="page-link" href="#">下一页</button>
            </li>
        </ul>
    </nav>


</div>


</div>


</section>

<div class="modal fade" id="newProductOption">
    <div class="modal-dialog">
        <div class="modal-content" style="overflow-x: scroll">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">商品信息</h4>
                <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body row">
                <label class="form-control-plaintext col-3 text-center">商品名称</label>
                <input type="text" name="productName" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  />
                <label class="form-control-plaintext col-3 text-center">商品库存</label>
                <input type="text" name="productNum" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px" oninput="value=value.replace(/[^\d]/g,'')" />
                <label class="form-control-plaintext col-3 text-center">商品价格</label>
                <input type="text" name="Price" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  oninput="value=value.replace(/[^\d.]$/g,'')"/>
                <label class="form-control-plaintext col-3 text-center">商品分类</label>
                <input type="text" name="category" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  />
                <label class="form-control-plaintext col-3 text-center">商品描述</label>
                <textarea type="text" name="description" class="input mx-auto w-100 col-9" style="font-size: 12px"></textarea>
                <label class="form-control-plaintext col-3 text-center">商品参数</label>
                <textarea type="text" name="parameter" class="input mx-auto w-100 col-9" style="height:200px;font-size: 12px" ></textarea>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn bg-danger" data-dismiss="modal">取消</button>
                <button id="newProducts" type="button" class="btn btn-secondary">提交</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="productOption">
    <div class="modal-dialog">
        <div class="modal-content" style="overflow-x: scroll">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">商品信息</h4>
                <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body row">
                <label class="form-control-plaintext col-3 text-center">商品名称</label>
                <input type="text" name="productName" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  />
                <label class="form-control-plaintext col-3 text-center">商品库存</label>
                <input type="text" name="productNum" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px" oninput="value=value.replace(/[^\d]/g,'')" />
                <label class="form-control-plaintext col-3 text-center">商品价格</label>
                <input type="text" name="Price" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  oninput="value=value.replace(/[^\d.]$/g,'')"/>
                <label class="form-control-plaintext col-3 text-center">商品分类</label>
                <input type="text" name="category" class="input input-group-text mx-auto w-100 col-9" style="height: 32px;font-size: 16px"  />
                <label class="form-control-plaintext col-3 text-center">商品描述</label>
                <textarea type="text" name="description" class="input mx-auto w-100 col-9" style="font-size: 12px"></textarea>
                <label class="form-control-plaintext col-3 text-center">商品参数</label>
                <textarea type="text" name="parameter" class="input mx-auto w-100 col-9" style="height:200px;font-size: 12px" ></textarea>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn bg-danger" data-dismiss="modal">取消</button>
                <button id="updateProducts" type="button" class="btn btn-secondary" data-dismiss="modal">提交</button>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="productImg">
    <div class="modal-dialog">
        <div class="modal-content" style="overflow-x: scroll">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">商品信息</h4>
                <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body row">
                <div id="showImg" class="col-12 row">

                </div>
                <label class="form-control-plaintext col-3 text-center">上传图片</label>
                <input multiple="multiple" type="file" name="productImg" class="input input-group-text mx-auto w-100 col-9" style="" accept='image/jpeg,image/png'/>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button id="updateProductImg" type="button" class="btn btn-secondary">上传图片</button>
                <button type="button" class="btn bg-danger" data-dismiss="modal">关闭</button>
            </div>

        </div>
    </div>
</div>

<script>
    function loop(fun,ms)
    {
        fun();
        setInterval(fun,ms);
    }

    $(document).ready(function () {
        $(".navigation").children().children().eq(2).addClass('active')
        loop(function () {
            if($(window).width() < 752){
                $('.changeSize').css({'max-width':''})
            }
            else
            {
                $('.changeSize').css({'max-width':'300px'})
            }
        },100)

        var x = 1

        function loadPage(x)
        {
            $.ajax({
                url:'../core/system.php',
                type:'POST',
                dataType:'json',
                data:{
                    'productList':'',
                    'pageNum':x
                },
                async:false,
                success:function (datas) {
                    contain = ''
                    maxPage = 0
                    rows = 0
                    now = 0
                    for (data in datas) {
                        if (data == 0) {
                            maxPage = datas[data]['maxPage']
                            rows = datas[data]['rows']
                            now = datas[data]['now']
                            continue
                        }
                        contain += "            <tr>\n" +
                            "                <td class=\"align-middle\" data-label=\"产品图片\"><img src=\"../images/product/" + datas[data][0] + "/img.jpg\" width=\"100\">\n" +
                            "                </td>\n" +
                            "                <td class=\"align-middle\" data-label=\"产品名称\"><a href='../product.php?pid="+ datas[data][0] +"'>" + datas[data][1] + "</a></td>\n" +
                            "                <td class=\"align-middle\" data-label=\"数量\">" + datas[data][2] + "</td>\n" +
                            "                <td class=\"align-middle\" data-label=\"价格\">" + datas[data][3] + "</td>\n" +
                            "                <td class=\"align-middle\" data-label=\"分类\">" + datas[data][4] + "</td>\n" +
                            "                <td class=\"align-middle changeSize\" data-label=\"描述\" style='white-space: pre;text-overflow: ellipsis;overflow-x: scroll'>" + datas[data][5] + "</td>\n" +
                            "                <td class=\"align-middle changeSize\" data-label=\"产品参数\" style='white-space: pre;text-overflow:ellipsis;overflow-x: scroll'><span\n" +
                            "                        class=\"text-dark px-3 py-2 \">" + datas[data][6] + "</span></td>\n" +
                            "                <td class=\"align-middle\" data-label=\"操作\" class=\"text-md-center dropdown dropleft\">\n" +
                            "                    <a href=\"#\" class=\"text-muted\" id=\"actionDropdown\" data-toggle=\"dropdown\"><span\n" +
                            "                            class=\"material-icons md-20 align-middle\">more_vert</span></a>\n" +
                            "                    <div class=\"dropdown-menu dropdown-menu-right\" aria-labelledby=\"actionDropdown\">\n" +
                            "                        <input pid='" + datas[data][0] + "' type='file' style='display: none' name='uploadShowImg' accept='image/jpeg,image/png'>"+
                            "                        <a pid='" + datas[data][0] + "' class=\"dropdown-item uploadShowImg\" href=\"#\">更新产品预览图</a>\n" +
                            "                        <a pid='" + datas[data][0] + "' class=\"dropdown-item updateProduct\" href=\"#\">更新商品信息</a>\n" +
                            // "                        <a pid='" + datas[data][0] + "' class=\"dropdown-item done\" href=\"#\">更新状态为：已完成</a>\n" +
                            // "                        <a pid='" + datas[data][0] + "' class=\"dropdown-item cancel\" href=\"#\">更新状态为：已取消</a>\n" +
                            "                        <input pid='" + datas[data][0] + "' type='file' style='display: none' name='uploadImg' multiple='multiple' accept='image/jpeg,image/png'>"+
                            "                        <a pid='" + datas[data][0] + "' class=\"dropdown-item uploadImg\" href=\"#\">更新产品展示图</a>\n" +
                            "                    </div>\n" +
                            "                </td>\n" +
                            "            </tr>"
                    }

                    $('#maxPage').text(maxPage)
                    $('#OrderNum').text(rows)
                    $('#now').val(now)
                    $('#orderList').html(contain)

                    if (now <= 1) {
                        $('#prev').addClass('disabled')
                    } else {
                        $('#prev').removeClass('disabled')
                    }

                    if (now >= maxPage) {
                        $('#next').addClass('disabled')
                    } else {
                        $('#next').removeClass('disabled')
                    }

                    $('#createNewProduct').on('click',function () {
                        $('#newProductOption div').eq(0).css({'max-width':'100%'})
                        $('#newProductOption div').eq(1).children().eq(1).css({'max-width':'100%'})
                        $('#newProductOption div').eq(1).children().eq(1).css({'width':$(window).width()})
                        $('#newProductOption div div textarea').css({'width':$(window).width() * 0.8})
                        $('#newProductOption').modal('show').css({'padding':0}).children().css({'margin-top': Math.max(0, ($(window).height() - $(this).height()/2) / 2)/4 });
                    })

                    $('#newProducts').on('click',function () {
                        if($('#newProductOption input[name="productName"]').val() != '' &&$('#newProductOption input[name="productNum"]').val() != '' && $('#newProductOption input[name="Price"]').val() != '' && $('#newProductOption input[name="category"]').val() != ''){
                            $.ajax({
                                url:'../core/system.php',
                                type:'POST',
                                dataType:'json',
                                data:{
                                    'newProducts':'',
                                    'productName':$('#newProductOption input[name="productName"]').val(),
                                    'productNum':$('#newProductOption input[name="productNum"]').val(),
                                    'Price':$('#newProductOption input[name="Price"]').val(),
                                    'category':$('#newProductOption input[name="category"]').val(),
                                    'description':$.base64.encode($('#newProductOption textarea[name="description"]').val()),
                                    "parameter":$.base64.encode($('#newProductOption textarea[name="parameter"]').val())
                                },
                                async:false,
                                success:function (datas) {
                                    if('error' in datas)
                                    {
                                        alert(datas['error'])
                                    }
                                    else
                                    {
                                        $('#newProductOption').modal('hide')
                                        x = $('#now').val();
                                        loadPage(x)
                                    }
                                }
                            })
                        }
                        else {
                            alert('请完善商品信息')
                        }


                    })


                    $('.updateProduct').on('click',function () {
                        $('#productOption div').eq(0).css({'max-width':'100%'})
                        $('#productOption div').eq(1).children().eq(1).css({'max-width':'100%'})
                        $('#productOption div').eq(1).children().eq(1).css({'width':$(window).width()})
                        $('#productOption div div textarea').css({'width':$(window).width() * 0.8})
                        $('#productOption').modal('show').css({'padding':0}).children().css({'margin-top': Math.max(0, ($(window).height() - $(this).height()/2) / 2)/4 });
                        $('#productOption input[name="productName"]').val($(this).parent().parent().parent().children().eq(1).text())
                        $('#productOption input[name="productNum"]').val($(this).parent().parent().parent().children().eq(2).text())
                        $('#productOption input[name="Price"]').val($(this).parent().parent().parent().children().eq(3).text())
                        $('#productOption input[name="category"]').val($(this).parent().parent().parent().children().eq(4).text())
                        $('#productOption textarea[name="description"]').text($(this).parent().parent().parent().children().eq(5).text())
                        $('#productOption textarea[name="parameter"]').text($(this).parent().parent().parent().children().eq(6).text())
                        $('#updateProducts').attr({'pid':$(this).attr('pid')})
                    })

                    $('#updateProducts').on('click',function () {
                        $.ajax({
                            url:'../core/system.php',
                            type:'POST',
                            dataType:'json',
                            data:{
                                'updateProducts':$(this).attr('pid'),
                                'productName':$('#productOption input[name="productName"]').val(),
                                'productNum':$('#productOption input[name="productNum"]').val(),
                                'Price':$('#productOption input[name="Price"]').val(),
                                'category':$('#productOption input[name="category"]').val(),
                                'description':$.base64.encode($('#productOption textarea[name="description"]').val()),
                                "parameter":$.base64.encode($('#productOption textarea[name="parameter"]').val())
                            },
                            async:false,
                            success:function (datas) {
                                if('error' in datas)
                                {
                                    alert(datas['error'])
                                }
                                else
                                {
                                    x = $('#now').val();
                                    loadPage(x)
                                }
                            }
                        })
                    })

                    $('.uploadShowImg').on('click', function () {
                        $(this).parent().children().eq(0).click()
                        $(this).parent().children().eq(0).on('change',function () {
                            var formdata = new FormData();
                            formdata.append('uploadShowImg','');
                            formdata.append('productID',$(this).attr('pid'));
                            formdata.append('file',$(this).prop('files')[0]);
                            $.ajax({
                                url:'../core/system.php',
                                type:'POST',
                                data:formdata,
                                cache:false,
                                processData:false,
                                contentType:false,
                                async:false,
                                success:function (data) {
                                    if('error' in data)
                                    {
                                        alert(data['error'])
                                    }
                                    else
                                    {
                                        x = $('#now').val();
                                        loadPage(x)
                                    }

                                }
                            })
                        })

                    })

                    function showImg(id){
                        $.ajax({
                            url:'../core/system.php',
                            type:'POST',
                            dataType:'json',
                            data:{
                                'showProductImg':id
                            },
                            async:false,
                            success:function (datas) {
                                content = ''
                                for( data in datas)
                                {
                                    path = datas[data].substr(datas[data].lastIndexOf('/')+1)
                                    content += '<div class="col-3 "><img alt="" class="img-fluid product-thumb" src="'+datas[data]+'" ><div class="text-center">'+path+'<a class="delImg" style="float: right;" href="#" path="'+path+'" >删除</a></div></div>'
                                }
                                $('#showImg').html(content)

                                $('.delImg').on('click',function () {
                                    $.ajax({
                                        url:'../core/system.php',
                                        type:'POST',
                                        dataType:'json',
                                        data:{
                                            'delImg':id,
                                            'path':$(this).attr('path')
                                        },
                                        async:false,
                                        success:function (data) {
                                            if('error' in data)
                                            {
                                                alert(data['error'])
                                            }
                                            else
                                            {
                                                showImg(id);
                                            }
                                        }
                                    })
                                })

                                $(document).ready(function () {

                                })

                            }

                        })
                    }

                    $('#updateProductImg').on('click',function () {
                        var id = $(this).attr('pid')
                        var formdata = new FormData();
                        formdata.append('uploadProductImg',id);
                        for( x=0;x<$('#productImg input[name="productImg"]')[0].files.length;x++)
                        {
                            formdata.append('file[]',$('#productImg input[name="productImg"]')[0].files[x]);
                        }
                        $.ajax({
                            url:'../core/system.php',
                            type:'POST',
                            data:formdata,
                            cache:false,
                            processData:false,
                            contentType:false,
                            async:false,
                            success:function (data) {
                                if('error' in data)
                                {
                                    alert(data['error'])
                                }
                                else
                                {
                                    showImg(id);
                                }
                            }
                        })
                    })

                    $('.uploadImg').on('click',function () {
                        $('#productImg div').eq(0).css({'max-width':'100%'})
                        $('#productImg div').eq(1).children().eq(1).css({'max-width':'100%'})
                        $('#productImg div').eq(1).children().eq(1).css({'width':$(window).width()})
                        $('#productImg').modal('show').css({'padding':0}).children().css({'margin-top': Math.max(0, ($(window).height() - $(this).height()/2) / 2)/4 });
                        $('#updateProductImg').attr({'pid':$(this).attr('pid')})
                        showImg($(this).attr('pid'))
                    })
                }
            })

        }
        $('#now').on('change', function () {
            if ($('#Now').val() <= 1) {
                $('#Now').val(1)
            }
            else if ($('#now').val() >= maxPage) {
                $('#now').val(maxPage)
            }
            loadPage($('#now').val())
            return null;
        })

        $('#prev').on('click', function () {
            if (!$(this).hasClass('disabled')) {
                x = $('#now').val();
                loadPage(parseInt(x)-1)
                return ;
            }
        })

        $('#next').on('click', function () {
            if (!$(this).hasClass('disabled')) {
                x = $('#now').val();
                loadPage(parseInt(x)+1)
                return ;
            }
        })
        loadPage(x)
    })
</script>